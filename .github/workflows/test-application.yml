name: Test Application Access

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  test-app:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Setup tools
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Get Application URL
      run: |
        aws eks update-kubeconfig --region us-east-1 --name innovatemart-eks
        
        # Try to get ALB URL
        ALB_URL=$(kubectl get ingress retail-store-ingress -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
        
        if [ -n "$ALB_URL" ]; then
          echo "ALB_URL=http://$ALB_URL" >> $GITHUB_ENV
          echo "Application URL: http://$ALB_URL"
        else
          # Fallback to service LoadBalancer
          SERVICE_URL=$(kubectl get service ui -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")
          if [ -n "$SERVICE_URL" ]; then
            echo "SERVICE_URL=http://$SERVICE_URL" >> $GITHUB_ENV
            echo "Service URL: http://$SERVICE_URL"
          else
            echo "No external URL found"
          fi
        fi

    - name: Test Application Connectivity
      if: env.ALB_URL != '' || env.SERVICE_URL != ''
      run: |
        URL="${{ env.ALB_URL }}${{ env.SERVICE_URL }}"
        echo "Testing connectivity to: $URL"
        
        # Test with curl
        curl -I --connect-timeout 30 --max-time 60 "$URL" || echo "Connection failed"
